# Bug Batch Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix 5 bugs: GH-4 (binary help), GH-5 (float64 panic), GH-6 (kebab-case), GH-7 (unknown tags), ISSUE-021 (--create codegen)

**Architecture:** Each bug is independent — fix with TDD, commit separately.

**Tech Stack:** Go, gomega, rapid

---

### Task 1: GH-5 — Add float64 flag type support

**Context:** `internal/core/parse.go:762-775` — `setFieldByKind` switch only handles string, int, bool, slice, map. float64 panics.

**Files:**
- Modify: `internal/core/parse.go:762-775`
- Test: Add test in appropriate parse test file

**Step 1: Write failing test**

Create a test with a struct containing `float64` field, pass a float value via CLI args, verify it parses correctly.

**Step 2: Fix**

Add `reflect.Float64` case to the switch in `setFieldByKind`:
```go
case reflect.Float64:
    v, err := strconv.ParseFloat(s, 64)
    if err != nil {
        return fmt.Errorf("invalid float64 value %q: %w", s, err)
    }
    fieldVal.SetFloat(v)
```

**Step 3: Run `go test -tags sqlite_fts5 ./...`, commit**

```
fix(parse): add float64 flag type support

Closes #5
```

---

### Task 2: GH-6 — Convert struct field names to kebab-case

**Context:** `internal/core/command.go:2043` — uses `strings.ToLower(field.Name)` instead of kebab-case conversion.

**Files:**
- Modify: `internal/core/command.go:2043`
- Possibly add a helper function for CamelCase → kebab-case conversion

**Step 1: Write failing test**

Test with struct field `MinRetrievals` and verify the generated flag name is `--min-retrievals`.

**Step 2: Fix**

Replace `strings.ToLower(field.Name)` with a camelCase-to-kebab-case converter. The converter should:
- Insert `-` before each uppercase letter that follows a lowercase letter
- Handle consecutive uppercase letters (acronyms) — e.g., `HTTPPort` → `http-port`
- Lowercase everything

**Step 3: Run `go test -tags sqlite_fts5 ./...`, commit**

Note: This is a BREAKING CHANGE for anyone using multi-word struct field names without explicit `name=`. Check if any internal code (dev/targets.go) uses multi-word fields without explicit names. If so, add explicit `name=` overrides to preserve behavior.

```
fix(flags): convert struct field names to kebab-case

BREAKING: Multi-word struct fields now generate kebab-case flags
(e.g., MinRetrievals → --min-retrievals instead of --minretrievals).
Add explicit name= tag to preserve old behavior if needed.

Closes #6
```

---

### Task 3: GH-7 — Error on unrecognized struct tag keys

**Context:** `internal/core/command.go:371-396` — `applyTagPart` silently ignores unknown tag keys.

**Files:**
- Modify: `internal/core/command.go:371-396`

**Step 1: Write failing test**

Test that a struct with `targ:"arg,required"` (using "arg" instead of "positional") returns an error at registration time.

**Step 2: Fix**

In `applyTagPart`, after checking all known keys, return an error for unrecognized keys. Include the unknown key and suggest valid alternatives in the error message.

**Step 3: Run `go test -tags sqlite_fts5 ./...`, commit**

IMPORTANT: Verify no existing code uses unknown tag keys that would break. Search the entire codebase for `targ:"` struct tags and ensure they all use recognized keys.

```
fix(tags): error on unrecognized struct tag keys

Reports unrecognized keys like "arg" at registration time instead
of silently treating them as flags.

Closes #7
```

---

### Task 4: GH-4 — Fix binary mode help output

**Context:** Three sub-problems in help generation:
1. `internal/help/generators.go:39,91` — Usage says "[targ flags...]" in binary mode
2. Runtime flags (--timeout, --parallel, etc.) shown in binary mode — shouldn't be
3. Examples reference "targ" instead of actual binary name

**Files:**
- Modify: `internal/help/generators.go`
- Modify: Wherever runtime flags are added to help output
- Check for binary mode detection (likely `RunOptions` or similar)

**Step 1: Write failing test**

Test that when running in binary mode (via `targ.Main`), help output:
- Says "[flags...]" not "[targ flags...]"
- Only shows --help and --completion flags
- Uses actual binary name in examples, not "targ"

**Step 2: Fix**

1. In generators.go, use "[flags...]" when in binary mode
2. Filter out runtime-only flags when generating help in binary mode
3. Use `opts.BinaryName` in example text instead of hardcoded "targ"

Need to determine how binary mode is detected — likely through a flag in the help generation options. If no such flag exists, add one and set it from `targ.Main()`.

**Step 3: Run `go test -tags sqlite_fts5 ./...`, commit**

```
fix(help): correct binary mode help output

Removes targ-specific flags and references from compiled binary
help output. Only --help and --completion shown. Binary name used
in examples instead of "targ".

Closes #4
```

---

### Task 5: ISSUE-021 — Fix --create code generation

**Context:** `internal/runner/runner.go:2277` — generates `var X = targ.Targ("cmd")` without explicit `targ.Register()` in `init()`.

**Files:**
- Modify: `internal/runner/runner.go` (code generation area)

**Step 1: Write failing test**

Test that `targ --create test "echo hello"` generates code with `targ.Register()` in `init()`.

**Step 2: Fix**

Update code generation to produce:
```go
func init() {
    targ.Register(targ.Targ("echo hello").Name("test"))
}
```

Check lines 186-233 (`AddTargetToFileWithFileOps`) — this may already handle the init() pattern correctly for existing files. The issue may be in the initial file creation path. Verify both paths: creating a new file and adding to an existing file.

**Step 3: Run `go test -tags sqlite_fts5 ./...`, commit**

```
fix(create): generate valid targ files with explicit registration

Closes toejough/targ#21
```
